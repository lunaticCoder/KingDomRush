{"version":3,"sources":["assets/scripts/levelScene/tower/arrow/arrower.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import ArrowBullet from \"./arrowBullet\";\nimport FrameAnimation from \"../../../common/frameAnimation\";\nimport Monster from \"../../monster/monster\";\nimport ArrowTower from \"./arrowTower\";\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class Arrower extends cc.Component {\n\n    private frameAnimation: FrameAnimation = null;\n\n    /**\n     * 是否正在射击\n     */\n    private shooting: boolean = false;\n    /**\n     * 塔的世界坐标\n     */\n    private wPosOfTower: cc.Vec2;\n    /**\n     * 箭的射出点 世界坐标\n     */\n    private wPosOfArrower: cc.Vec2;\n    /**\n     * 射箭动画播放时间\n     */\n    private playTimeOfshootArrow: number;\n    private arrowTower: ArrowTower = null;\n    private monsterArray: Monster[];\n\n    private attack: number;\n    private speedOfArrow: number;\n    private shootRange: number;\n    private speedOfShoot: number;\n\n    onLoad() {\n        this.frameAnimation = this.node.getComponent(\"frameAnimation\");\n        this.arrowTower = this.node.parent.getComponent(\"arrowTower\");\n        this.monsterArray = Monster.monstersOfAlive;\n    }\n\n    start() {\n        //初始化数据\n        this.wPosOfArrower = this.node.parent.convertToWorldSpaceAR(this.node.getPosition());\n        this.playTimeOfshootArrow = this.frameAnimation.getDuration();\n\n    }\n\n    /**\n     * Inits arrower\n     * @param wPosOfTower 塔的世界坐标\n     * @param speedOfArrow 箭的移动速度\n     * @param shootRange 射程\n     * @param speedOfShoot 射速\n     */\n    init(wPosOfTower: cc.Vec2, speedOfArrow: number, shootRange: number, speedOfShoot: number, attack: number) {\n        this.wPosOfTower = wPosOfTower;\n        this.speedOfArrow = speedOfArrow;\n        this.shootRange = shootRange;\n        this.speedOfShoot = speedOfShoot;\n        this.attack = attack;\n    }\n\n    /**\n     * Shoots arrower\n     * @param des 射击目标，世界坐标\n     * @param time 射到目的地的时间\n     */\n    private shoot(des: cc.Vec2, time: number = null) {\n        if (this.shooting)\n            return;\n        this.shooting = true;\n\n        if (time === null) {\n            let l: number = this.wPosOfTower.sub(des).mag();\n            let time = l / this.speedOfArrow;\n        }\n\n        //播放动作后射箭\n        this.frameAnimation.play(false, false, false, function () {\n            let arrowBullet: ArrowBullet = this.createArrow();\n            let dir: boolean;\n            if (this.wPosOfTower.x > des.x)\n                dir = true;\n            else\n                dir = false;\n            arrowBullet.init(this.attack, this.speedOfArrow, dir);\n            arrowBullet.moveTo(this.wPosOfArrower, des, time);\n            this.coolingShoot();\n        }.bind(this));\n    }\n\n    /**\n     * 冷却 射击\n     */\n    private coolingShoot() {\n        this.scheduleOnce(function () {\n            this.shooting = false;\n        }.bind(this), this.speedOfShoot);\n    }\n\n    /**\n     * Creates arrow\n     * @returns arrow ArrowBullet\n     */\n    private createArrow(): ArrowBullet {\n        let arrow: cc.Node = this.arrowTower.getArrowBullet();\n        this.node.addChild(arrow);\n        let script: ArrowBullet = arrow.getComponent(\"arrowBullet\");\n        return script;\n    }\n\n    /**\n     * 根据怪物此时的位置，预判子弹到达后，怪物的新位置\n     * @param monster \n     * @param cP 此时怪物的坐标 世界坐标\n     * @returns null表示超出射程;[怪物预测位置,世界; 子弹达到预测位置的时间]\n     */\n    private forecastMovePos(monster: Monster, cP: cc.Vec2): number[] {\n\n        //箭飞行到cP的时间\n        let time: number = cP.sub(this.wPosOfArrower).mag() / this.speedOfArrow;\n\n        let mWP: cc.Vec2 = monster.getPosInTime(time + this.playTimeOfshootArrow);\n        if (!this.inShootRange(mWP))\n            return null;\n        return [mWP.x, mWP.y, time];\n    }\n\n    private inShootRange(wP: cc.Vec2): boolean {\n        let l: number = this.wPosOfTower.sub(wP).mag();\n        if (l <= this.shootRange)\n            return true;\n        return false;\n    }\n\n    update(dt) {\n        if (!this.shooting) {\n            for (let i = 0; i < this.monsterArray.length; i++) {\n                let m: Monster = this.monsterArray[i];\n                let mP: cc.Vec2 = m.node.parent.convertToWorldSpaceAR(m.node.getPosition());\n\n                if (this.inShootRange(mP)) {\n                    if (m.swiOfRecursionInPW) {\n                        let d: number[] = this.forecastMovePos(m, mP);\n                        if (d === null)\n                            continue;\n                        this.shoot(cc.v2(d[0], d[1]), d[2]);\n                        break;\n                    }\n                    else {\n                        this.shoot(m.getWPos());\n                        return;\n                    }\n                }\n            }\n        }\n    }\n\n}\n"]}