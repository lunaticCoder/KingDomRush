{"version":3,"sources":["assets/scripts/levelScene/tower/artillery/artilleryTower.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import FrameAnimation from \"../../../common/frameAnimation\";\nimport ArtilleryBullet from \"./artilleryBullet\";\nimport GameDataStorage, { GameConfig } from \"../../../common/module/gameDataManager\";\nimport Monster from \"../../monster/monster\";\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass(\"ArtilleryFrames\")\nclass ArtilleryFrames {\n    @property({\n        type: [cc.SpriteFrame]\n    })\n    frames: cc.SpriteFrame[] = [];\n\n    @property({\n        type: [cc.SpriteFrame],\n        tooltip: \"炮弹的图片\"\n    })\n    bullet: cc.SpriteFrame[] = [];\n}\n\n@ccclass\nexport default class Artillery extends cc.Component {\n\n    @property({\n        type: ArtilleryFrames,\n        tooltip: \"塔的图片资源\"\n    })\n    private towers: ArtilleryFrames[] = [];\n\n    @property({\n        type: [cc.Node],\n        tooltip: \"填弹动画的子弹的节点\"\n    })\n    private addBulletNodes: cc.Node[] = [];\n\n    @property({\n        type: [cc.Prefab],\n    })\n    private bulletPrefab: cc.Prefab[] = [];\n\n    private frameAnimation: FrameAnimation = null;\n    private gameConfig: GameConfig;\n    private monsterArray: Monster[];\n    private bg: cc.Node = null;\n\n\n    /* 数据 */\n    private addBulletData = [\n        {\n            startPos: cc.v2(-20, 10), //bg下的节点坐标\n            ctrlPos: cc.v2(-11, 55),\n            endPos: cc.v2(3, 20),\n            shootDelay: 0.9,\n            addBulletDelay: 1.4\n        },\n        {\n            startPos: cc.v2(-22, 16),\n            ctrlPos: cc.v2(-12, 55),\n            endPos: cc.v2(3, 25),\n            shootDelay: 1.1,\n            addBulletDelay: 1.8\n\n        },\n        {\n            startPos: cc.v2(-22, 16),\n            ctrlPos: cc.v2(-13, 55),\n            endPos: cc.v2(4, 25),\n            shootDelay: 0.9,\n            addBulletDelay: 1.4\n\n        },\n    ]\n    /**\n     * 塔的世界坐标\n     */\n    private wPos: cc.Vec2 = null;\n    private poolsOfBullet: cc.NodePool[] = [];\n    private dataOfTower: any[];\n\n    /* 塔的属性 */\n    level: number = 1;\n    maxLevel: number = 3;\n    private speedOfBullet: number;\n    /**\n     * 炸弹爆炸范围\n     */\n    private bombRange: number;\n    shootRange: number;\n    /**\n     * 攻击力\n     */\n    attack: number;\n    private intervalOfShoot: number;\n    price: number;\n\n    /* 控制 */\n    private shootable: boolean = false;\n\n    onLoad() {\n        this.bg = this.node.getChildByName(\"bg\");\n        this.frameAnimation = this.bg.getComponent(\"frameAnimation\");\n        this.gameConfig = GameDataStorage.getGameConfig();\n        this.dataOfTower = this.gameConfig.getDataOfArtillery();\n        this.monsterArray = Monster.monstersOfAlive;\n\n        this.createPoolsOfBullet();\n    }\n\n    start() {\n        this.init();\n    }\n\n    /**\n     * 初始化攻击力、动画、\n     * @returns  \n     */\n    init() {\n        this.attack = this.dataOfTower[this.level - 1].attack;\n        this.speedOfBullet = this.dataOfTower[this.level - 1].speedOfBullet;\n        this.bombRange = this.dataOfTower[this.level - 1].bombRange;\n        this.shootRange = this.dataOfTower[this.level - 1].shootRange;\n        this.intervalOfShoot = this.dataOfTower[this.level - 1].intervalOfShoot;\n        this.price = this.dataOfTower[this.level - 1].price;\n\n        this.frameAnimation.setFrameArray(this.towers[this.level - 1].frames);\n        this.frameAnimation.setSpriteFrame(this.towers[this.level - 1].frames[0]);\n        this.wPos = this.node.parent.convertToWorldSpaceAR(this.node.getPosition());\n\n        this.addBulletNodes[0].getComponent(cc.Sprite).spriteFrame = this.towers[this.level - 1].bullet[0];\n\n        this.addBulletAnim();\n        this.scheduleOnce((() => { this.shootable = true; }).bind(this), this.intervalOfShoot);\n    }\n\n    /* 炮弹对象池 */\n    private createPoolsOfBullet() {\n        for (let i = 0; i < this.bulletPrefab.length; i++) {\n            this.poolsOfBullet.push(new cc.NodePool());\n            let p: cc.Prefab = this.bulletPrefab[i];\n            this.poolsOfBullet[i].put(cc.instantiate(p));\n        }\n    }\n    getBullet(level: number): cc.Node {\n        let r: cc.Node = null;\n        if (this.poolsOfBullet[level - 1].size() > 0)\n            r = this.poolsOfBullet[level].get();\n        else\n            r = cc.instantiate(this.bulletPrefab[level - 1]);\n        r.opacity = 255;\n        return r;\n    }\n    releaseBullt(level: number, n: cc.Node) {\n        this.poolsOfBullet[level - 1].put(n);\n    }\n    private clearPoolsOfBullet() {\n        for (let i = 0; i < this.poolsOfBullet.length; i++)\n            this.poolsOfBullet[i].clear();\n    }\n\n    /**\n     * 射击\n     * @param des 世界坐标\n     * @param time 子弹到des的时间\n     */\n    private shoot(des: cc.Vec2, time: number = null) {\n        if (!this.shootable)\n            return;\n        this.shootable = false;\n\n        if (time === null) {\n            let l: number = this.wPos.sub(des).mag();\n            let time = l / this.speedOfBullet;\n        }\n\n        this.frameAnimation.play(false, false, false, function () {\n            this.shootBullet(des, time);\n            this.addBulletAnim();\n            this.scheduleOnce((() => {\n                this.shootable = true;\n            }).bind(this), this.intervalOfShoot);\n        }.bind(this));\n    }\n\n    /**\n     * 射出子弹\n     */\n    private shootBullet(des: cc.Vec2, time: number) {\n        let a: ArtilleryBullet = this.createBullet();\n        let wPos: cc.Vec2 = this.bg.convertToWorldSpaceAR(this.addBulletData[this.level - 1].endPos);\n        a.moveTo(wPos, des, time);\n    }\n\n    private createBullet(): ArtilleryBullet {\n        let artillery: ArtilleryBullet = cc.instantiate(this.bulletPrefab[this.level - 1]).getComponent(\"artilleryBullet\");\n        this.node.addChild(artillery.node);\n        artillery.init(this.level, this.attack, this.bombRange);\n        let bg: cc.Node = this.node.getChildByName(\"bg\");\n        return artillery;\n    }\n\n    /**\n     * 根据怪物此时的位置，预判子弹到达后，怪物的新位置\n     * @param monster \n     * @param cP 此时怪物的坐标 世界坐标\n     * @returns 怪物预测位置,世界; 子弹达到预测位置的时间\n     */\n    private forecastMovePos(monster: Monster, cP: cc.Vec2): number[] {\n        //从填弹到子弹飞行到cP的时间\n        let bulletStartPos: cc.Vec2 = this.bg.convertToWorldSpaceAR(this.addBulletData[this.level - 1].endPos);\n        let time: number = cP.sub(bulletStartPos).mag() / this.speedOfBullet + this.addBulletData[this.level - 1].shootDelay;\n\n        let mWP: cc.Vec2 = monster.getPosInTime(time);\n        if (!this.inShootRange(mWP))\n            return null;\n        return [mWP.x, mWP.y, time - this.addBulletData[this.level - 1].shootDelay];\n    }\n\n    /**\n     * 播放填弹动画\n     */\n    private addBulletAnim() {\n        this.addBulletNodes[0].scale = 1;\n        this.addBulletNodes[0].setPosition(this.addBulletData[this.level - 1].startPos);\n        let a: cc.ActionInterval = cc.bezierTo(0.5, [this.addBulletData[this.level - 1].startPos, this.addBulletData[this.level - 1].ctrlPos, this.addBulletData[this.level - 1].endPos]);\n        let func: cc.ActionInstant = cc.callFunc(function () {\n            this.addBulletNodes[0].scale = 0;\n        }, this);\n        let seq: cc.ActionInterval = cc.sequence(a, func);\n        this.addBulletNodes[0].runAction(seq);\n    }\n\n    destroySelf() {\n        this.clearPoolsOfBullet();\n        this.node.destroy();\n    }\n\n    /**\n     * 升级\n     */\n    upgrade() {\n        if (this.level === this.maxLevel)\n            return;\n        this.level++;\n        this.init();\n    }\n\n    getPriceOfUpgrade(): number {\n        return this.dataOfTower[this.level].price;\n    }\n\n    getDataOfTower(): any[] {\n        return this.dataOfTower;\n    }\n\n    /**\n     * 判断该点是否在射程内\n     * @param pos 世界坐标\n     */\n    private inShootRange(pos: cc.Vec2): boolean {\n        let l: number = this.wPos.sub(pos).mag();\n        if (l <= this.shootRange)\n            return true;\n        return false;\n    }\n\n    update(dt) {\n        if (this.shootable) {\n            for (let i = 0; i < this.monsterArray.length; i++) {\n                let m: Monster = this.monsterArray[i];\n                let mP: cc.Vec2 = m.getWPos();\n                if (this.inShootRange(mP)) {\n                    if (m.swiOfRecursionInPW) {\n                        let d: number[] = this.forecastMovePos(m, mP);\n                        if (d !== null) {\n                            this.shoot(cc.v2(d[0], d[1]), d[2]);\n                            return;\n                        }\n                    }\n                    else {\n                        this.shoot(m.getWPos());\n                        return;\n                    }\n                }\n            }\n        }\n    }\n}\n"]}