{"version":3,"sources":["assets/scripts/levelScene/tower/magiclan/magiclanTower.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import FrameAnimation from \"../../../common/frameAnimation\";\nimport MagiclanBullet from \"./magiclanBullet\";\nimport Monster from \"../../monster/monster\";\nimport GameDataStorage, { GameConfig } from \"../../../common/module/gameDataManager\";\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass(\"MagiclanFrames\")\nclass MagiclanFrames {\n    @property({\n        type: [cc.SpriteFrame]\n    })\n    frames: cc.SpriteFrame[] = [];\n}\n\n@ccclass\nexport default class MagiclanTower extends cc.Component {\n\n    @property({\n        type: [cc.Vec2],\n        tooltip: \"各等级的法师的Y坐标\"\n    })\n    private offsetY: cc.Vec2[] = [];\n\n    @property({\n        type: [MagiclanFrames],\n        tooltip: \"它的帧图片\"\n    })\n    private framesArray: MagiclanFrames[] = [];\n\n    @property({ //0,1为 法师1的朝下和朝上的帧图片\n        type: [MagiclanFrames],\n        tooltip: \"法师的帧图片\"\n    })\n    private magiclanFrames: MagiclanFrames[] = [];\n\n    @property({\n        type: cc.Prefab\n    })\n    private bulletPrefab: cc.Prefab = null;\n\n    @property({\n        type: cc.Node,\n        displayName: \"射击点\"\n    })\n    private PosOfShoot: cc.Node = null;\n\n    /**\n     * 法师的 帧动画组件\n     */\n    private magiclanAF: FrameAnimation = null;\n    /**\n     * 塔的 帧动画\n     */\n    private towerAF: FrameAnimation = null;\n    private bg: cc.Node = null;\n    private monsterArray: Monster[];\n\n    /* 塔的属性 */\n    /**\n     * 塔的等级\n     */\n    level: number = 1;\n    maxLevel: number = 4;\n    private speedOfShoot: number;\n    private speedOfBullet: number;\n    private attack: number;\n    shootRange: number;\n    price: number;\n\n\n    /* 控制 */\n    /**\n     * false为法师朝下\n     */\n    private toward: boolean = false;\n    private isShoot: boolean = false;\n\n    /* 数据 */\n    /**\n     * 法球发射点 世界\n     */\n    private wPOfShoot: cc.Vec2;\n    /**\n     * 塔的坐标 世界\n     */\n    private wPos: cc.Vec2 = null;\n    /**\n     * 发射动画播放时间\n     */\n    private playTOfShoot: number;\n    private poolOfBullet: cc.NodePool = null;\n    private dataOfTower: any[];\n\n    onLoad() {\n        this.magiclanAF = this.node.getChildByName(\"magiclan\").getComponent(\"frameAnimation\");\n        this.towerAF = this.node.getChildByName(\"bg\").getComponent(\"frameAnimation\");\n        this.bg = this.node.getChildByName(\"bg\");\n        this.monsterArray = Monster.monstersOfAlive;\n        let gc: GameConfig = GameDataStorage.getGameConfig();\n        this.dataOfTower = gc.getDataOfMagiclan();\n        this.createPoolOfBullet();\n    }\n\n    start() {\n        this.wPos = this.node.parent.convertToWorldSpaceAR(this.node.getPosition());\n        this.wPOfShoot = this.PosOfShoot.parent.convertToWorldSpaceAR(this.PosOfShoot.getPosition());\n        this.init();\n    }\n\n    /**\n     * 根据塔的等级 设置塔的图片和骨骼动画\n     */\n    private init() {\n        this.attack = this.dataOfTower[this.level - 1].attack;\n        this.speedOfShoot = this.dataOfTower[this.level - 1].speedOfShoot;\n        this.speedOfBullet = this.dataOfTower[this.level - 1].speedOfBullet;\n        this.shootRange = this.dataOfTower[this.level - 1].shootRange;\n        this.price = this.dataOfTower[this.level - 1].price;\n\n        this.initMagiclanAF();\n        this.initTowerAF();\n    }\n\n    /* 对象池 */\n    private createPoolOfBullet() {\n        if (this.poolOfBullet !== null)\n            return;\n        this.poolOfBullet = new cc.NodePool();\n        for (let i = 0; i < 1; i++) {\n            this.poolOfBullet.put(cc.instantiate(this.bulletPrefab));\n        }\n    }\n    getBullet(): cc.Node {\n        let r: cc.Node = null;\n        if (this.poolOfBullet.size() > 0)\n            r = this.poolOfBullet.get();\n        else\n            r = cc.instantiate(this.bulletPrefab);\n        r.opacity = 255;\n        return r;\n    }\n    releaseBullt(n: cc.Node) {\n        this.poolOfBullet.put(n);\n    }\n    private clearPoolOfBullet() {\n        this.poolOfBullet.clear();\n    }\n\n    /**\n     * 初始化法师，更新帧动画和位置，发射动画播放时间\n     */\n    private initMagiclanAF() {\n        let i: number;\n        if (this.level === 4) {\n            i = 2;\n        }\n        else {\n            i = 0;\n        }\n        if (this.toward)\n            i++;\n        this.magiclanAF.setFrameArray(this.magiclanFrames[i].frames);\n        this.magiclanAF.setSpriteFrame(this.magiclanFrames[i].frames[0]);\n        this.playTOfShoot = this.magiclanAF.getDuration();\n\n        this.magiclanAF.node.setPosition(this.offsetY[this.level - 1]);\n    }\n\n    /**\n     * 改变法师的朝向\n     * @param toward false为 朝下\n     */\n    private changeToward(toward: boolean) {\n        if (toward === this.toward)\n            return;\n        this.toward = toward;\n        this.initMagiclanAF();\n    }\n\n    /**\n     * 初始化塔，更新帧动画\n     */\n    private initTowerAF() {\n        this.towerAF.setFrameArray(this.framesArray[this.level - 1].frames);\n        this.towerAF.setSpriteFrame(this.framesArray[this.level - 1].frames[0]);\n    }\n\n    /**\n     * Shoots arrow tower\n     * @param des 世界坐标\n     * @param time 子弹到des的时间\n     */\n    private shoot(des: cc.Vec2, time: number = null) {\n        if (this.isShoot)\n            return;\n        this.isShoot = true;\n\n        if (time === null) {\n            let l: number = this.wPos.sub(des).mag();\n            let time = l / this.speedOfBullet;\n        }\n\n        //更新法师方向\n        let wPos: cc.Vec2 = this.node.convertToWorldSpaceAR(this.magiclanAF.node.getPosition());\n        if (wPos.y > des.y && this.toward === true)\n            this.toward = false;\n        else if (wPos.y < des.y && this.toward === false)\n            this.toward = true;\n        this.initMagiclanAF();\n\n        this.towerAF.play(false);\n        this.magiclanAF.play(false, true, false, function () {\n            let bulletScr: MagiclanBullet = this.createBullet();\n            bulletScr.moveTo(this.wPOfShoot, des, time);\n            this.coolingShoot();\n        }.bind(this));\n\n    }\n\n    /**\n     * 冷却 射击\n     */\n    private coolingShoot() {\n        this.scheduleOnce(function () {\n            this.isShoot = false;\n        }.bind(this), this.speedOfShoot);\n    }\n\n    private createBullet(): MagiclanBullet {\n        let bullet: cc.Node = this.getBullet();\n        let script: MagiclanBullet = bullet.getComponent(\"magiclanBullet\");\n        this.node.addChild(bullet);\n        script.init(this.attack);\n        return script;\n    }\n\n    destroySelf() {\n        this.clearPoolOfBullet();\n        this.node.destroy();\n    }\n\n    /**\n     * 升级\n     */\n    upgrade() {\n        if (this.level === 4)\n            return;\n        this.level++;\n        this.init();\n    }\n\n    getPriceOfUpgrade(): number {\n        return this.dataOfTower[this.level].price;\n    }\n\n    getDataOfTower(): any[] {\n        return this.dataOfTower;\n    }\n\n    /**\n     * 判断该点是否在射程内\n     * @param pos 世界坐标\n     */\n    private inShootRange(pos: cc.Vec2): boolean {\n        let l: number = this.wPos.sub(pos).mag();\n        if (l <= this.shootRange)\n            return true;\n        return false;\n    }\n\n    /**\n     * 根据怪物此时的位置，预判子弹到达后，怪物的新位置\n     * @param monster \n     * @param cP 此时怪物的坐标 世界坐标\n     * @returns 怪物预测位置,世界; 子弹达到预测位置的时间\n     */\n    private forecastMovePos(monster: Monster, cP: cc.Vec2): number[] {\n        //法球飞行到cP的时间\n        let time: number = cP.sub(this.wPOfShoot).mag() / this.speedOfBullet;\n\n        let mWP: cc.Vec2 = monster.getPosInTime(time + this.playTOfShoot);\n        if (!this.inShootRange(mWP))\n            return null;\n        return [mWP.x, mWP.y, time];\n    }\n\n    update(dt) {\n        if (!this.isShoot) {\n            for (let i = 0; i < this.monsterArray.length; i++) {\n                let m: Monster = this.monsterArray[i];\n                let mP: cc.Vec2 = m.node.parent.convertToWorldSpaceAR(m.node.getPosition());\n\n                if (this.inShootRange(mP)) {\n                    if (m.swiOfRecursionInPW) {\n\n                        let d: number[] = this.forecastMovePos(m, mP);\n                        if (d === null)\n                            continue;\n                        this.shoot(cc.v2(d[0], d[1]), d[2]);\n                        break;\n                    }\n                    else {\n                        this.shoot(m.getWPos());\n                        break;\n                    }\n                }\n            }\n        }\n\n    }\n}\n"]}